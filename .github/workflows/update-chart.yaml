name: Build and Publish Kyverno Policy Helm Chart

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 1'  # Weekly sync every Monday at 3 AM UTC

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout default branch
      uses: actions/checkout@v3

    - name: Set up Helm
      uses: azure/setup-helm@v3

    - name: Prepare folders
      run: |
        mkdir -p kyverno-policies/templates
        mkdir -p dynamic-policies
        rm -f dynamic-policies/*.yaml
        rm -f kyverno-policies/templates/*.yaml

    - name: Download dynamic Kyverno policies
      run: |
        curl -sSL -f -o dynamic-policies/disallow-capabilities.yaml \
          https://raw.githubusercontent.com/nirmata/kyverno-policies/main/pod-security/baseline/disallow-capabilities/disallow-capabilities.yaml

        curl -sSL -f -o dynamic-policies/restrict-volume-types.yaml \
          https://raw.githubusercontent.com/nirmata/kyverno-policies/main/pod-security/restricted/restrict-volume-types/restrict-volume-types.yaml

        curl -sSL -f -o dynamic-policies/restrict-sysctls.yaml \
          https://raw.githubusercontent.com/nirmata/kyverno-policies/main/pod-security/baseline/restrict-sysctls/restrict-sysctls.yaml

    - name: Copy dynamic policies to templates
      run: |
        shopt -s nullglob
        files=(dynamic-policies/*.yaml)
        if [ ${#files[@]} -eq 0 ]; then
          echo "⚠️ No dynamic policies found."
        else
          cp -v "${files[@]}" kyverno-policies/templates/
        fi

    - name: Copy static policies to templates
      run: |
        shopt -s nullglob
        files=(static-policies/*.yaml)
        if [ ${#files[@]} -eq 0 ]; then
          echo "⚠️ No static policies found."
        else
          cp -v "${files[@]}" kyverno-policies/templates/
        fi

    - name: Templatize validationFailureAction
      run: |
        for file in kyverno-policies/templates/*.yaml; do
          sed -i 's/validationFailureAction: [A-Za-z]*/validationFailureAction: {{ .Values.validationFailureAction | default "Audit" }}/' "$file"
        done

    - name: Bump chart version
      run: |
        CHART_FILE="kyverno-policies/Chart.yaml"
        CURRENT_VERSION=$(grep '^version:' $CHART_FILE | awk '{print $2}')
        NEXT_VERSION=$(echo $CURRENT_VERSION | awk -F. '{$NF+=1}1' | sed 's/ /./g')
        sed -i "s/^version: .*/version: $NEXT_VERSION/" $CHART_FILE
        echo "Bumped chart version: $CURRENT_VERSION -> $NEXT_VERSION"

    - name: Package Helm chart
      run: |
        helm package kyverno-policies --destination ./

    - name: Checkout gh-pages branch
      uses: actions/checkout@v3
      with:
        ref: gh-pages
        path: gh-pages
        persist-credentials: true

    - name: Copy packaged chart and update index
      run: |
        cp *.tgz gh-pages/
        cd gh-pages
        helm repo index . --url https://nirmata.github.io/tennet-helm-chart/
        git config user.name "${{ github.actor }}"
        git config user.email "${{ github.actor }}@users.noreply.github.com"
        git add .
        git commit -m "Update Helm repo index $(date -u +'%Y-%m-%dT%H:%M:%SZ')" || echo "No changes to commit"
        git push origin gh-pages
